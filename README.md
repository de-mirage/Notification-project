# Платформа сервиса уведомлений

- [Архитектура](#архитектура)
- [Функции](#функции)
- [Обзор сервисов](#обзор-сервисов)
- [Стек технологий](#стек-технологий)
- [Мониторинг и метрики](#мониторинг-и-метрики)
- [Начало работы](#начало-работы)
- [Примеры использования](#примеры-использования)
- [Расширение платформы](#расширение-платформы)
- [Структура проекта](#структура-проекта)

## Архитектура

Платформа уведомлений следует архитектуре микросервисов с четким разделением ответственности:

```
┌─────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│  Notification   │    │                  │    │                  │
│    Gateway      │ ──>│  Router Service  │───>│  Email Service   │
│ (API Endpoint)  │    │ (Message Routing)│    │(Email Processing)│
└─────────────────┘    └──────────────────┘    └──────────────────┘
                                │                          │
                                \/                         \/
                       ┌──────────────────┐    ┌──────────────────┐
                       │   SMS Service    │    │   Push Service   │
                       │(SMS Processing)  │    │(Push Processing) │
                       └──────────────────┘    └──────────────────┘
                                │
                                \/
                       ┌──────────────────┐
                       │  Status API      │
                       │ (Status Tracking)│
                       └──────────────────┘
```
- todo: добавить либо нормальную диаграмму (картинкой), либо описать словами архитектуру (не красиво выглядит)

### Основные компоненты:

1. **Notification Gateway**: Точка входа публичного API для отправки уведомлений
2. **Router Service**: Маршрутизирует сообщения к соответствующим сервисам обработки через RabbitMQ
3. **Processing Services**: Специализированные сервисы для каждого типа уведомлений (Email, SMS, Push)
4. **Status API**: Обеспечивает отслеживание статуса уведомлений
5. **Computing Service**: Обрабатывает вычислительные задачи с использованием Orleans
6. **Database**: PostgreSQL для хранения записей уведомлений и отслеживания статуса
7. **Message Broker**: RabbitMQ для асинхронного обмена сообщениями между сервисами

## Функции

- **Многоканальные уведомления**: Поддержка email, SMS и push-уведомлений
- **Асинхронная обработка**: Неблокирующие операции с использованием очередей сообщений RabbitMQ
- **Масштабируемая архитектура**: Независимо развертываемые микросервисы
- **Надежность**: Механизмы повторных попыток и обработка ошибок
- **Мониторинг**: Интеграция Prometheus и Grafana для метрик и дашбордов
- **Отслеживание статуса**: Мониторинг статуса уведомлений в реальном времени
- **Массовая отправка уведомлений**: Отправка нескольких уведомлений в одном запросе
- **Обработка с приоритетами**: Разные уровни приоритета для уведомлений
- **Хранение данных**: PostgreSQL для хранения записей уведомлений

## Обзор сервисов

| Сервис | Порт | Описание |
|--------|------|----------|
| Notification Gateway | 8080 | Точка входа REST API для отправки уведомлений |
| Computing Service | 8083 | Обрабатывает вычислительные задачи с использованием Orleans |
| Status API | 8082 | Обеспечивает отслеживание статуса уведомлений |
| RabbitMQ Management | 15672 | Интерфейс администрирования RabbitMQ |
| PostgreSQL | 5432 | База данных для записей уведомлений |
| Prometheus | 9090 | Сбор метрик и мониторинг |
| Grafana | 3000 | Дашборд визуализации метрик |

## Стек технологий

- **Backend**: .NET 8, C#
- **Database**: PostgreSQL
- **Messaging**: RabbitMQ
- **Контейнеризация**: Docker, Docker Compose
- **Мониторинг**: Prometheus, Grafana
- **Документация API**: Swagger/OpenAPI
- **ORM**: Entity Framework Core

## Мониторинг и метрики

Платформа включает интегрированный мониторинг с Prometheus и Grafana:

- **Prometheus**: Сбор метрик с сервисов
- **Grafana**: Визуализация метрик с преднастроенными дашбордами
- **Состояние сервисов**: Проверки работоспособности всех сервисов
- **Метрики производительности**: Частота запросов, задержки, частота ошибок

### Доступ к инструментам мониторинга:

- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (admin/admin)

## Начало работы

### Предварительные требования

- Docker и Docker Compose
- .NET 8 SDK (для локальной разработки)

### Запуск с Docker

```bash
# Клонирование репозитория
git clone <repository-url>
cd Notification-project

# Запуск сервисов с использованием Docker Compose
docker-compose up --build
```

Это выполнит:
1. Сборку всех образов Docker
2. Запуск всех сервисов
3. Инициализацию баз данных и очередей сообщений

### Запуск без Docker (разработка)

Для локальной разработки без Docker:

1. Установите PostgreSQL и RabbitMQ
2. Обновите строки подключения в файлах `appsettings.json`
3. Запустите каждый сервис отдельно:
   ```bash
   cd src/NotificationGateway
   dotnet run
   ```

Сервисы будут доступны на портах, указанных в разделе [Обзор сервисов](#обзор-сервисов).

## Примеры использования

### Отправка Email уведомления

```bash
curl -X POST http://localhost:8080/api/notifications/send \
-H "Content-Type: application/json" \
-d '{
    "recipient": "test@example.com",
    "message": "Single test Email",
    "type": "email"
}'
```

### Проверка статуса уведомления

```bash
curl http://localhost:8080/api/notifications/{notification-id}
```

### Отправка массовых уведомлений

```bash
curl -X POST http://localhost:8080/api/notifications/send-bulk \
  -H "Content-Type: application/json" \
  -d '[
    {
      "recipient": "user1@example.com",
      "message": "Это первое массовое email уведомление",
      "type": "Email",
    },
    {
      "recipient": "user2@example.com",
      "message": "Это второе массовое email уведомление",
      "type": "Email"
    }
  ]'
```

## Расширение платформы

Для добавления нового типа уведомления (например, Slack уведомлений):

1. **Создание нового сервиса**:
   - Создайте новую директорию проекта (например, `src/SlackService`)
   - Реализуйте логику обработки в сервисе-обработчике
   - Добавьте потребителя RabbitMQ для вашей очереди

2. **Обновление Router Service**:
   - Добавьте имя вашей очереди в RouterService (`slack_notifications`)
   - Обновите логику маршрутизации для пересылки сообщений в вашу очередь
   - Добавьте необходимые переменные окружения

3. **Обновление Gateway**:
   - Добавьте ваш тип уведомления в перечисление `NotificationType`
   - Обновите валидацию при необходимости

4. **Обновление Docker Compose**:
   - Добавьте ваш новый сервис в `docker-compose.yml`
   - Настройте переменные окружения и зависимости

5. **Обновление мониторинга**:
   - Добавьте ваш сервис в `prometheus.yml` для сбора метрик

## Структура проекта

```
src/
├── NotificationGateway/        # Точка входа публичного API
├── RouterService/              # Маршрутизация сообщений к соответствующим сервисам
├── EmailService/               # Обработка email уведомлений
├── SmsService/                 # Обработка SMS уведомлений
├── PushService/                # Обработка push уведомлений
├── StatusApi/                  # Отслеживание статуса уведомлений
├── ComputingService/           # Вычислительные задачи с Orleans
├── NotificationService.Models/ # Общие модели и структуры данных
├── Common.DTO/                 # Общие DTO
├── Common.Messaging/           # Общие компоненты обмена сообщениями
└── Common.Utils/               # Общие утилиты
```